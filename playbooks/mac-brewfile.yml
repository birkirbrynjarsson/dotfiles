---
- name: Manage Homebrew packages via Brewfile from dotfiles
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # Path to your dotfiles repo on the Mac
    dotfiles_dir: "{{ lookup('env', 'HOME') }}/dotfiles"

    # Where the Brewfile lives in your dotfiles repo
    brewfile_path: "{{ dotfiles_dir }}/Brewfile"

    # mode: install | dump
    brewfile_mode: "install"

    # If true, remove installed brews/casks not listed in Brewfile (dangerous but useful)
    brew_cleanup: false

    # Add comments/descriptions when dumping
    brew_dump_describe: true

  tasks:
    - name: Ensure macOS
      ansible.builtin.assert:
        that:
          - ansible_facts['system'] == "Darwin"
        fail_msg: "This playbook is intended for macOS (Darwin)."

    - name: Check if brew exists
      ansible.builtin.command: which brew
      register: brew_which
      changed_when: false
      failed_when: false

    - name: Install Homebrew (if missing)
      ansible.builtin.shell: |
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      args:
        creates: /opt/homebrew/bin/brew
      when: brew_which.rc != 0

    - name: Ensure brew is on PATH for this run (Apple Silicon default)
      ansible.builtin.set_fact:
        brew_path: "/opt/homebrew/bin:/usr/local/bin:{{ lookup('env', 'PATH') }}"

    # ---- INSTALL MODE: enforce Brewfile on machine ----
    - name: Assert Brewfile exists in dotfiles repo (install mode)
      ansible.builtin.stat:
        path: "{{ brewfile_path }}"
      register: brewfile_stat
      when: brewfile_mode == "install"

    - name: Fail if dotfiles Brewfile missing (install mode)
      ansible.builtin.fail:
        msg: "No Brewfile found at {{ brewfile_path }}. Create it or run with -e brewfile_mode=dump first."
      when:
        - brewfile_mode == "install"
        - not brewfile_stat.stat.exists

    - name: Check if mas is installed
      ansible.builtin.command: which mas
      register: mas_which
      changed_when: false
      failed_when: false

    - name: Upgrade Mac App Store apps (mas upgrade)
      ansible.builtin.command: mas upgrade
      environment:
        PATH: "{{ brew_path }}"
      when:
        - brewfile_mode == "install"
        - mas_which.rc == 0
      changed_when: false
      failed_when: false

    - name: Update Homebrew metadata (recommended in install mode)
      ansible.builtin.command: brew update
      environment:
        PATH: "{{ brew_path }}"
      when: brewfile_mode == "install"
      changed_when: false
      failed_when: false

    - name: Install/upgrade everything in Brewfile (brew bundle)
      ansible.builtin.command: brew bundle --file="{{ brewfile_path }}"
      environment:
        PATH: "{{ brew_path }}"
      when: brewfile_mode == "install"

    - name: Cleanup anything not in Brewfile (optional)
      ansible.builtin.command: brew bundle cleanup --file="{{ brewfile_path }}" --force
      environment:
        PATH: "{{ brew_path }}"
      when:
        - brewfile_mode == "install"
        - brew_cleanup | bool

    # ---- DUMP MODE: regenerate Brewfile from machine ----
    - name: Dump installed brews/casks into dotfiles Brewfile
      ansible.builtin.command: >
        brew bundle dump --file="{{ brewfile_path }}" --force
        {{ '--describe' if brew_dump_describe | bool else '' }}
      environment:
        PATH: "{{ brew_path }}"
      when: brewfile_mode == "dump"
